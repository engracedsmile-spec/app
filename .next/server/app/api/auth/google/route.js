"use strict";(()=>{var e={};e.id=1718,e.ids=[1718],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39386:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>c});var t={};a.r(t),a.d(t,{POST:()=>u});var i=a(49303),n=a(88716),s=a(60670),o=a(87070),l=a(6128);async function u(e){try{let r;let{adminAuth:a,adminDb:t}=(0,l.IW)(),i=e.headers.get("Authorization");if(!i)return o.NextResponse.json({message:"No authorization token provided"},{status:401});let n=i.split("Bearer ")[1],{uid:s,email:u,name:d,picture:m}=await (0,l.y3)(n),c=t.collection("users").doc(s),p=await c.get();if(p.exists)r={id:p.id,...p.data()};else{let e;try{e=await a.getUserByEmail(u);let i=t.collection("users").doc(e.uid);if((p=await i.get()).exists)return r={id:p.id,...p.data()},o.NextResponse.json({success:!0,user:r});{let a={id:e.uid,userId:e.uid,name:d||e.displayName||"User",email:u,phone:e.phoneNumber||"",userType:"customer",status:"Active",dateJoined:new Date().toISOString().split("T")[0],walletBalance:0,profilePictureUrl:m||e.photoURL||"",referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),referralCount:0,referredBy:"",fcmToken:"",walletPin:""};return await i.set(a),r=a,o.NextResponse.json({success:!0,user:r})}}catch(e){if("auth/user-not-found"===e.code){try{await a.getUser(s)}catch(e){if("auth/user-not-found"===e.code)await a.createUser({uid:s,email:u,displayName:d,photoURL:m,emailVerified:!0});else throw e}let e={id:s,userId:s,name:d||"Google User",email:u,phone:"",userType:"customer",status:"Active",dateJoined:new Date().toISOString().split("T")[0],walletBalance:0,profilePictureUrl:m||"",referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),referralCount:0,referredBy:"",fcmToken:"",walletPin:""};await c.set(e),r=e}else throw e}}return o.NextResponse.json({success:!0,user:r})}catch(e){if(console.error("API Google Sign-In Error:",e),e.message.includes("Firebase Admin SDK is not initialized"))return o.NextResponse.json({message:"Server Error: Firebase Admin SDK not initialized."},{status:500});return o.NextResponse.json({message:e.message||"An internal server error occurred."},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/google/route",pathname:"/api/auth/google",filename:"route",bundlePath:"app/api/auth/google/route"},resolvedPagePath:"/root/app/src/app/api/auth/google/route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:c,serverHooks:p}=d,g="/api/auth/google/route";function h(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:c})}},6128:(e,r,a)=>{a.d(r,{FH:()=>d,IW:()=>l,y3:()=>u});var t=a(92509),i=a.n(t),n=a(60325),s=a(89155);let o=null;function l(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let r={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:i().initializeApp({credential:i().credential.cert(r),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:i().firestore(e),adminAuth:i().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let u=e=>{let{adminAuth:r}=l();return r.verifyIdToken(e)},d=async(e,r)=>{let{adminDb:a}=l(),t=await u(e),i=(await a.doc(`users/${t.uid}`).get()).data();if(!i)throw Error(`Permission Denied: User with UID ${t.uid} not found in Firestore.`);let n=i.role;if(!n||!s._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!s._[n]?.includes(r))throw Error(`Permission Denied: User with role '${n}' does not have the required '${r}' permission.`);return!0}},89155:(e,r,a)=>{a.d(r,{_:()=>t});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let t={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[8948,5059],()=>a(39386));module.exports=t})();