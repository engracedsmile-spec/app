"use strict";(()=>{var e={};e.id=4424,e.ids=[4424],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},81757:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>P,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>v,serverHooks:()=>b,staticGenerationAsyncStorage:()=>k});var r={};t.r(r),t.d(r,{POST:()=>m});var s=t(49303),n=t(88716),i=t(60670),o=t(87070),c=t(6128),l=t(12594),d=t(42e3),u=t(6113),p=t.n(u);async function m(e){try{let{adminDb:a}=(0,c.IW)(),t=await e.text(),r=e.headers.get("x-paystack-signature");if(!r)return console.error("Paystack webhook: Missing signature"),o.NextResponse.json({message:"Missing signature"},{status:400});let s=await (0,d.Rs)(),n=s?.paystackLiveSecretKey;if(!n)return console.error("Paystack webhook: Secret key not configured"),o.NextResponse.json({message:"Webhook not configured"},{status:500});if(p().createHmac("sha512",n).update(t).digest("hex")!==r)return console.error("Paystack webhook: Invalid signature"),o.NextResponse.json({message:"Invalid signature"},{status:400});let i=JSON.parse(t);switch(console.log("Paystack webhook received:",i.event,i.data.reference),i.event){case"charge.success":await g(a,i.data);break;case"charge.failed":await f(a,i.data);break;case"transfer.success":await y(a,i.data);break;case"transfer.failed":await h(a,i.data);break;default:console.log("Unhandled Paystack event:",i.event)}return o.NextResponse.json({message:"Webhook processed"},{status:200})}catch(e){return console.error("Paystack webhook error:",e),o.NextResponse.json({message:"Webhook processing failed"},{status:500})}}async function g(e,a){let{reference:t,amount:r,customer:s,metadata:n}=a,i=r/100;console.log("Processing successful payment:",t,i);try{let r=e.collection("payments").doc(t),o={id:t,reference:t,amount:i,status:"success",customerEmail:s?.email,customerName:s?.first_name+" "+s?.last_name,paymentMethod:"paystack",type:"payment",description:n?.description||"Payment via Paystack",date:l.FieldValue.serverTimestamp(),metadata:n||{},rawData:a};if(await r.set(o),n?.bookingId){let a=e.collection("bookings").doc(n.bookingId);await a.update({status:"Confirmed",paymentReference:t,paymentDate:l.FieldValue.serverTimestamp()})}if(n?.userId&&n?.type==="wallet_funding"){let a=e.collection("users").doc(n.userId),r=e.collection(`users/${n.userId}/transactions`).doc(t),s=e.batch();s.update(a,{walletBalance:l.FieldValue.increment(i)}),s.set(r,{id:t,userId:n.userId,type:"credit",amount:i,description:"Wallet funding via Paystack",date:l.FieldValue.serverTimestamp(),status:"completed",reference:t}),await s.commit()}console.log("Payment processed successfully:",t)}catch(e){console.error("Error processing successful payment:",e)}}async function f(e,a){let{reference:t,amount:r,customer:s,metadata:n}=a,i=r/100;console.log("Processing failed payment:",t,i);try{let r=e.collection("payments").doc(t),o={id:t,reference:t,amount:i,status:"failed",customerEmail:s?.email,customerName:s?.first_name+" "+s?.last_name,paymentMethod:"paystack",type:"payment",description:n?.description||"Failed payment via Paystack",date:l.FieldValue.serverTimestamp(),metadata:n||{},rawData:a};if(await r.set(o),n?.bookingId){let a=e.collection("bookings").doc(n.bookingId);await a.update({status:"Payment Failed",paymentReference:t,paymentDate:l.FieldValue.serverTimestamp()})}console.log("Failed payment recorded:",t)}catch(e){console.error("Error processing failed payment:",e)}}async function y(e,a){let{reference:t,amount:r,recipient:s,metadata:n}=a,i=r/100;console.log("Processing successful transfer:",t,i);try{let r=e.collection("transfers").doc(t),o={id:t,reference:t,amount:i,status:"success",recipientName:s?.name,recipientAccount:s?.account_number,recipientBank:s?.bank?.name,type:"transfer",description:n?.description||"Transfer via Paystack",date:l.FieldValue.serverTimestamp(),metadata:n||{},rawData:a};await r.set(o),console.log("Transfer processed successfully:",t)}catch(e){console.error("Error processing successful transfer:",e)}}async function h(e,a){let{reference:t,amount:r,recipient:s,metadata:n}=a,i=r/100;console.log("Processing failed transfer:",t,i);try{let r=e.collection("transfers").doc(t),o={id:t,reference:t,amount:i,status:"failed",recipientName:s?.name,recipientAccount:s?.account_number,recipientBank:s?.bank?.name,type:"transfer",description:n?.description||"Failed transfer via Paystack",date:l.FieldValue.serverTimestamp(),metadata:n||{},rawData:a};await r.set(o),console.log("Failed transfer recorded:",t)}catch(e){console.error("Error processing failed transfer:",e)}}let v=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/paystack/route",pathname:"/api/webhooks/paystack",filename:"route",bundlePath:"app/api/webhooks/paystack/route"},resolvedPagePath:"/root/app/src/app/api/webhooks/paystack/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:k,serverHooks:b}=v,P="/api/webhooks/paystack/route";function x(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:k})}},6128:(e,a,t)=>{t.d(a,{FH:()=>d,IW:()=>c,y3:()=>l});var r=t(92509),s=t.n(r),n=t(60325),i=t(89155);let o=null;function c(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let a={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:s().initializeApp({credential:s().credential.cert(a),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:s().firestore(e),adminAuth:s().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let l=e=>{let{adminAuth:a}=c();return a.verifyIdToken(e)},d=async(e,a)=>{let{adminDb:t}=c(),r=await l(e),s=(await t.doc(`users/${r.uid}`).get()).data();if(!s)throw Error(`Permission Denied: User with UID ${r.uid} not found in Firestore.`);let n=s.role;if(!n||!i._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!i._[n]?.includes(a))throw Error(`Permission Denied: User with role '${n}' does not have the required '${a}' permission.`);return!0}},89155:(e,a,t)=>{t.d(a,{_:()=>r});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let r={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}},42e3:(e,a,t)=>{t.d(a,{Hu:()=>d,Rs:()=>u});var r=t(93820),s=t(29362);let n={apiKey:"AIzaSyB1p5ckuVJpKYR0EUmzweOv42L0GwyhH_M",authDomain:"studio-8506488239-824d2.firebaseapp.com",projectId:"studio-8506488239-824d2",storageBucket:"studio-8506488239-824d2.appspot.com",messagingSenderId:"589723373931",appId:"1:589723373931:web:2e466b46a359c56cc37c2e"};function i(){return(0,s.C6)().length?(0,s.Mq)():(0,s.ZF)(n)}let o={driverRegistrationOpen:!0,driverRegistrationLimit:100,seatHoldDuration:5,requireEmailVerification:!1,requirePhoneVerification:!0,seatBookingEnabled:!0,charterBookingEnabled:!0,referralSystemEnabled:!0,referralBonus:500,authMethods:{email:!0,google:!0}},c={paystackLivePublicKey:"pk_test_a041f0f86a34c38d2a6a5831505c219662d5930e",paystackLiveSecretKey:""},l=null,d=async()=>{let e=i();if(l)return l;let a=(0,r.ad)(e),t=(0,r.JU)(a,"settings","operations");try{let e=await (0,r.QT)(t);if(!e.exists())return o;{let a={...o,...e.data()};return l=a,a}}catch(e){return console.error("Failed to fetch or set operations settings",e),o}};async function u(){let e=i(),a=(0,r.ad)(e),t=(0,r.JU)(a,"settings","payment");try{let e=await (0,r.QT)(t);if(e.exists())return{...c,...e.data()};return c}catch(e){return console.error("Failed to fetch payment settings",e),c}}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[8948,5059,7999],()=>t(81757));module.exports=r})();