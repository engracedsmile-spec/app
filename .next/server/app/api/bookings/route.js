"use strict";(()=>{var e={};e.id=1946,e.ids=[1946],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},82031:(e,a,i)=>{i.r(a),i.d(a,{originalPathname:()=>f,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var r={};i.r(r),i.d(r,{POST:()=>u});var t=i(49303),n=i(88716),s=i(60670),o=i(24330);i(60166);var d=i(6128),p=i(12594),c=i(40618);let l=(e,a)=>{let i=0;return"fixed"===a.discountType?i=a.discountValue:"percentage"===a.discountType&&(i=a.discountValue/100*e),{discountedPrice:Math.max(0,e-i),discountAmount:i}};async function u(e){let{adminDb:a}=(0,d.IW)(),{formData:i,user:r,scheduledTripId:t}=await e.json(),n=e.headers.get("Authorization"),s=r?.id||null;if(!s&&n){let e=n.split("Bearer ")[1];try{s=(await (0,d.y3)(e)).uid}catch(e){}}if("charter"===i.bookingType)return new Response(JSON.stringify({message:"Invalid endpoint for charter booking."}),{status:400});return o(i,s,t);async function o(e,i,r){let t=a.collection("bookings");try{let n;let s=t.doc(),o=e.price||0;if(e.couponCode){let i=await a.collection("promotions").where("code","==",e.couponCode.toUpperCase()).where("status","==","active").limit(1).get();if(i.empty)return new Response(JSON.stringify({message:"The coupon code is invalid or has expired."}),{status:400});{let e=i.docs[0].data();if("all"===e.applicableTo||"seat_booking"===e.applicableTo){let{discountedPrice:a,discountAmount:i}=l(o,e);o=a,n={code:e.code,amount:i}}else throw Error("This coupon code is not valid for this booking type.")}}let d=[e.passengerName,...e.passengers?.map(e=>e.name)||[]].filter(Boolean),c={id:s.id,userId:i,type:"passenger",bookingType:"seat_booking",status:"Pending",createdAt:p.FieldValue.serverTimestamp(),passengerName:e.passengerName,passengers:d,passengerPhone:e.passengerPhone,travelDate:e.travelDate,scheduledTripId:r,pickupAddress:e.pickupAddress,destinationAddress:e.destinationAddress,itemDescription:`Seat(s) ${e.seats.join(", ")}`,seats:e.seats,title:`Trip to ${e.destinationAddress.split(",")[0]}`,price:o,...n&&{discount:n}};return await s.set(c),new Response(JSON.stringify({bookingId:s.id,finalPrice:o}),{status:200})}catch(e){return console.error("Error creating passenger booking:",e),new Response(JSON.stringify({message:e.message||"Failed to create your booking due to a server error."}),{status:500})}}}(0,c.h)([u]),(0,o.j)("ebb9bcce285f7cb51b37feb8c2cb7a699ecfaced",u);let g=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:"app/api/bookings/route"},resolvedPagePath:"/root/app/src/app/api/bookings/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:h}=g,f="/api/bookings/route";function b(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},49303:(e,a,i)=>{e.exports=i(30517)},6128:(e,a,i)=>{i.d(a,{FH:()=>c,IW:()=>d,y3:()=>p});var r=i(92509),t=i.n(r),n=i(60325),s=i(89155);let o=null;function d(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let a={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:t().initializeApp({credential:t().credential.cert(a),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:t().firestore(e),adminAuth:t().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let p=e=>{let{adminAuth:a}=d();return a.verifyIdToken(e)},c=async(e,a)=>{let{adminDb:i}=d(),r=await p(e),t=(await i.doc(`users/${r.uid}`).get()).data();if(!t)throw Error(`Permission Denied: User with UID ${r.uid} not found in Firestore.`);let n=t.role;if(!n||!s._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!s._[n]?.includes(a))throw Error(`Permission Denied: User with role '${n}' does not have the required '${a}' permission.`);return!0}},89155:(e,a,i)=>{i.d(a,{_:()=>r});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let r={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}}};var a=require("../../../webpack-runtime.js");a.C(e);var i=e=>a(a.s=e),r=a.X(0,[8948,8341],()=>i(82031));module.exports=r})();