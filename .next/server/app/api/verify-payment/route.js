"use strict";(()=>{var e={};e.id=5767,e.ids=[5767],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},87697:(e,a,i)=>{i.r(a),i.d(a,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var r={};i.r(r),i.d(r,{POST:()=>p});var t=i(49303),n=i(88716),s=i(60670),o=i(24330);i(60166);var d=i(6128),l=i(12594);async function p(e){let{adminDb:a}=(0,d.IW)(),{reference:i,bookingId:r}=await e.json();if(console.log("Payment verification request:",{reference:i,bookingId:r}),!r)return new Response(JSON.stringify({message:"Booking ID is required."}),{status:400});try{let e=a.collection("bookings").doc(r),i=null,t=null;await a.runTransaction(async n=>{let s=await n.get(e);if(!s.exists)throw Error(`Booking with ID ${r} not found.`);let o=s.data();if("Pending"!==o.status){console.log(`Booking ${r} already processed with status: ${o.status}`);return}console.log(`Processing payment verification for booking ${r}`);let d=null,p=null;if("passenger"===o.type&&o.scheduledTripId){let e=a.collection("scheduledTrips").doc(o.scheduledTripId);if((d=await n.get(e)).exists){let e=d.data()?.vehicleId;if(e){let i=a.collection("vehicles").doc(e);p=await n.get(i)}}else throw Error("Scheduled trip for this booking could not be found.")}p&&p.exists&&(i=p.data()?.wifiPassword||null,t=p.data()?.wifiId||null);let u="charter"===o.type?"Confirmed":"On Progress";if(n.update(e,{status:u,wifiPassword:i,wifiSSID:t}),d&&d.exists){let e=[o.passengerName,...o.passengers||[]].filter(Boolean),a=(o.seats||[]).map((a,i)=>({name:e[i]||`Passenger ${i+1}`,seat:a})),i={bookedSeats:l.FieldValue.arrayUnion(...o.seats||[]),passengers:l.FieldValue.arrayUnion(...a)};(o.seats||[]).forEach(e=>{i[`seatHolds.${e}`]=l.FieldValue.delete()}),n.update(d.ref,i)}});let n=(await e.get()).data(),s={code:n.id,passengerName:n.passengerName,passengers:n.passengers,pickupAddress:n.pickupAddress,destinationAddress:n.destinationAddress,itemDescription:n.itemDescription,travelDate:n.travelDate,title:n.title,wifiPassword:n.wifiPassword,wifiSSID:n.wifiSSID};return new Response(JSON.stringify({success:!0,bookingDetails:s}),{status:200})}catch(e){return console.error("Error finalizing booking:",e),new Response(JSON.stringify({message:e.message||"An internal server error occurred during booking finalization."}),{status:500})}}(0,i(40618).h)([p]),(0,o.j)("94a519d61d51a0389a3b3d1f4d29359cdf381a03",p);let u=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/verify-payment/route",pathname:"/api/verify-payment",filename:"route",bundlePath:"app/api/verify-payment/route"},resolvedPagePath:"/root/app/src/app/api/verify-payment/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:g}=u,f="/api/verify-payment/route";function v(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},49303:(e,a,i)=>{e.exports=i(30517)},6128:(e,a,i)=>{i.d(a,{FH:()=>p,IW:()=>d,y3:()=>l});var r=i(92509),t=i.n(r),n=i(60325),s=i(89155);let o=null;function d(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let a={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:t().initializeApp({credential:t().credential.cert(a),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:t().firestore(e),adminAuth:t().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let l=e=>{let{adminAuth:a}=d();return a.verifyIdToken(e)},p=async(e,a)=>{let{adminDb:i}=d(),r=await l(e),t=(await i.doc(`users/${r.uid}`).get()).data();if(!t)throw Error(`Permission Denied: User with UID ${r.uid} not found in Firestore.`);let n=t.role;if(!n||!s._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!s._[n]?.includes(a))throw Error(`Permission Denied: User with role '${n}' does not have the required '${a}' permission.`);return!0}},89155:(e,a,i)=>{i.d(a,{_:()=>r});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let r={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}}};var a=require("../../../webpack-runtime.js");a.C(e);var i=e=>a(a.s=e),r=a.X(0,[8948,8341],()=>i(87697));module.exports=r})();