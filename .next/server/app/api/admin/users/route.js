"use strict";(()=>{var e={};e.id=2628,e.ids=[2628],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},98609:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c});var s={};a.r(s),a.d(s,{GET:()=>d,POST:()=>m});var t=a(49303),i=a(88716),n=a(60670),o=a(87070),u=a(6128);/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */async function d(e){try{let{adminDb:r}=(0,u.IW)(),a=e.headers.get("Authorization");if(!a)return o.NextResponse.json({message:"No authorization token provided"},{status:401});let s=a.split("Bearer ")[1];await (0,u.FH)(s,"manageUsers");let t=(await r.collection("users").get()).docs.map(e=>({id:e.id,...e.data()}));return o.NextResponse.json(t)}catch(r){if(console.error("API Error in /api/admin/users (GET):",r),r.message.includes("Firebase Admin SDK is not initialized"))return o.NextResponse.json({message:"Server Error: Firebase Admin SDK not initialized."},{status:500});let e=r.message.includes("Permission Denied")?403:500;return o.NextResponse.json({message:r.message||"Internal Server Error"},{status:e})}}async function m(e){try{let{adminAuth:r,adminDb:a}=(0,u.IW)(),s=e.headers.get("Authorization");if(!s)return o.NextResponse.json({message:"No authorization token provided"},{status:401});let t=s.split("Bearer ")[1];await (0,u.FH)(t,"manageUsers");let{email:i,password:n,name:d,phone:m,userType:l,role:p}=await e.json();if(!i||!n||!d||!l)return o.NextResponse.json({message:"Missing required fields."},{status:400});let c=await r.createUser({email:i,password:n,displayName:d,phoneNumber:m}),g={id:c.uid,userId:c.uid,name:d,email:i,phone:m||"",userType:l,status:"Active",dateJoined:new Date().toISOString().split("T")[0],walletBalance:0,walletPin:"",referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),referralCount:0,referredBy:"",fcmToken:"",profilePictureUrl:"",..."admin"===l&&{role:p||"Support"}};return await a.collection("users").doc(c.uid).set(g),o.NextResponse.json({success:!0,user:{id:c.uid,...g}},{status:201})}catch(e){if(console.error("API Error creating user:",e),e.message.includes("Firebase Admin SDK is not initialized"))return o.NextResponse.json({message:"Server Error: Firebase Admin SDK not initialized."},{status:500});if("auth/email-already-exists"===e.code)return o.NextResponse.json({message:"A user with this email already exists."},{status:409});if("auth/phone-number-already-exists"===e.code)return o.NextResponse.json({message:"A user with this phone number already exists."},{status:409});if("auth/invalid-phone-number"===e.code)return o.NextResponse.json({success:!1,message:"The phone number must be a valid E.164 string (e.g., +11234567890)."},{status:400});return o.NextResponse.json({message:e.message||`Internal Server Error: ${e.code}`},{status:500})}}let l=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"/root/app/src/app/api/admin/users/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:c,serverHooks:g}=l,h="/api/admin/users/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},6128:(e,r,a)=>{a.d(r,{FH:()=>m,IW:()=>u,y3:()=>d});var s=a(92509),t=a.n(s),i=a(60325),n=a(89155);let o=null;function u(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let r={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,i.getApps)().length?(0,i.getApps)()[0]:t().initializeApp({credential:t().credential.cert(r),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:t().firestore(e),adminAuth:t().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let d=e=>{let{adminAuth:r}=u();return r.verifyIdToken(e)},m=async(e,r)=>{let{adminDb:a}=u(),s=await d(e),t=(await a.doc(`users/${s.uid}`).get()).data();if(!t)throw Error(`Permission Denied: User with UID ${s.uid} not found in Firestore.`);let i=t.role;if(!i||!n._[i])throw Error(`Permission Denied: User role '${i}' is not defined or has no permissions.`);if(!n._[i]?.includes(r))throw Error(`Permission Denied: User with role '${i}' does not have the required '${r}' permission.`);return!0}},89155:(e,r,a)=>{a.d(r,{_:()=>s});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let s={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),s=r.X(0,[8948,5059],()=>a(98609));module.exports=s})();