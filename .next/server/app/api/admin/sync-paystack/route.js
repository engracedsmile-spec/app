"use strict";(()=>{var e={};e.id=1233,e.ids=[1233],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},63918:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{POST:()=>m});var s=a(49303),n=a(88716),i=a(60670),o=a(87070),c=a(6128),d=a(12594),u=a(42e3);async function m(e){try{let{adminDb:t}=(0,c.IW)(),a=e.headers.get("Authorization");if(!a)return o.NextResponse.json({message:"No authorization token provided"},{status:401});let r=a.split("Bearer ")[1];await (0,c.FH)(r,"managePayouts");let{startDate:s,endDate:n}=await e.json();if(!s||!n)return o.NextResponse.json({message:"Start date and end date are required"},{status:400});let i=await (0,u.Rs)(),m=i?.paystackLiveSecretKey;if(!m)return o.NextResponse.json({message:"Paystack secret key not configured"},{status:500});console.log("Syncing Paystack payments from",s,"to",n);let l=await p(m,s,n),g=0,y=0;for(let e of l)try{if((await t.collection("payments").doc(e.reference).get()).exists){y++;continue}let a={id:e.reference,reference:e.reference,amount:e.amount/100,status:"success"===e.status?"success":"failed",customerEmail:e.customer?.email,customerName:e.customer?.first_name+" "+e.customer?.last_name,paymentMethod:"paystack",type:"payment",description:e.metadata?.description||"Payment via Paystack",date:d.FieldValue.serverTimestamp(),originalDate:new Date(e.created_at),metadata:e.metadata||{},rawData:e,syncedAt:d.FieldValue.serverTimestamp()};if(await t.collection("payments").doc(e.reference).set(a),e.metadata?.bookingId){let a=t.collection("bookings").doc(e.metadata.bookingId);(await a.get()).exists&&"success"===e.status&&await a.update({status:"Confirmed",paymentReference:e.reference,paymentDate:d.FieldValue.serverTimestamp()})}if(e.metadata?.userId&&e.metadata?.type==="wallet_funding"&&"success"===e.status){let a=t.collection("users").doc(e.metadata.userId),r=t.collection(`users/${e.metadata.userId}/transactions`).doc(e.reference),s=t.batch();s.update(a,{walletBalance:d.FieldValue.increment(e.amount/100)}),s.set(r,{id:e.reference,userId:e.metadata.userId,type:"credit",amount:e.amount/100,description:"Wallet funding via Paystack",date:d.FieldValue.serverTimestamp(),status:"completed",reference:e.reference}),await s.commit()}g++,console.log("Synced payment:",e.reference,e.amount/100)}catch(t){console.error("Error syncing transaction:",e.reference,t)}return o.NextResponse.json({success:!0,message:`Synced ${g} payments, skipped ${y} existing payments`,syncedCount:g,skippedCount:y,totalTransactions:l.length})}catch(e){return console.error("API Error in /api/admin/sync-paystack:",e),o.NextResponse.json({message:e.message||"Internal Server Error"},{status:500})}}async function p(e,t,a){let r=[],s=1;try{for(;;){let n=`https://api.paystack.co/transaction?perPage=100&page=${s}&from=${t}&to=${a}`,i=await fetch(n,{headers:{Authorization:`Bearer ${e}`}});if(!i.ok)throw Error(`Paystack API error: ${i.status}`);let o=await i.json();if(!o.status||!o.data||0===o.data.length||(r.push(...o.data),o.data.length<100))break;s++}return console.log(`Fetched ${r.length} transactions from Paystack`),r}catch(e){throw console.error("Error fetching Paystack transactions:",e),Error("Failed to fetch transactions from Paystack")}}let l=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/sync-paystack/route",pathname:"/api/admin/sync-paystack",filename:"route",bundlePath:"app/api/admin/sync-paystack/route"},resolvedPagePath:"/root/app/src/app/api/admin/sync-paystack/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:f}=l,h="/api/admin/sync-paystack/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},6128:(e,t,a)=>{a.d(t,{FH:()=>u,IW:()=>c,y3:()=>d});var r=a(92509),s=a.n(r),n=a(60325),i=a(89155);let o=null;function c(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let t={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:s().initializeApp({credential:s().credential.cert(t),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:s().firestore(e),adminAuth:s().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let d=e=>{let{adminAuth:t}=c();return t.verifyIdToken(e)},u=async(e,t)=>{let{adminDb:a}=c(),r=await d(e),s=(await a.doc(`users/${r.uid}`).get()).data();if(!s)throw Error(`Permission Denied: User with UID ${r.uid} not found in Firestore.`);let n=s.role;if(!n||!i._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!i._[n]?.includes(t))throw Error(`Permission Denied: User with role '${n}' does not have the required '${t}' permission.`);return!0}},89155:(e,t,a)=>{a.d(t,{_:()=>r});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let r={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}},42e3:(e,t,a)=>{a.d(t,{Hu:()=>u,Rs:()=>m});var r=a(93820),s=a(29362);let n={apiKey:"AIzaSyB1p5ckuVJpKYR0EUmzweOv42L0GwyhH_M",authDomain:"studio-8506488239-824d2.firebaseapp.com",projectId:"studio-8506488239-824d2",storageBucket:"studio-8506488239-824d2.appspot.com",messagingSenderId:"589723373931",appId:"1:589723373931:web:2e466b46a359c56cc37c2e"};function i(){return(0,s.C6)().length?(0,s.Mq)():(0,s.ZF)(n)}let o={driverRegistrationOpen:!0,driverRegistrationLimit:100,seatHoldDuration:5,requireEmailVerification:!1,requirePhoneVerification:!0,seatBookingEnabled:!0,charterBookingEnabled:!0,referralSystemEnabled:!0,referralBonus:500,authMethods:{email:!0,google:!0}},c={paystackLivePublicKey:"pk_test_a041f0f86a34c38d2a6a5831505c219662d5930e",paystackLiveSecretKey:""},d=null,u=async()=>{let e=i();if(d)return d;let t=(0,r.ad)(e),a=(0,r.JU)(t,"settings","operations");try{let e=await (0,r.QT)(a);if(!e.exists())return o;{let t={...o,...e.data()};return d=t,t}}catch(e){return console.error("Failed to fetch or set operations settings",e),o}};async function m(){let e=i(),t=(0,r.ad)(e),a=(0,r.JU)(t,"settings","payment");try{let e=await (0,r.QT)(a);if(e.exists())return{...c,...e.data()};return c}catch(e){return console.error("Failed to fetch payment settings",e),c}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5059,7999],()=>a(63918));module.exports=r})();