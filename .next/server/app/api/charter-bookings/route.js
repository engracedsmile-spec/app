"use strict";(()=>{var e={};e.id=2640,e.ids=[2640],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55144:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h});var t={};r.r(t),r.d(t,{POST:()=>g});var i=r(49303),n=r(88716),s=r(60670),o=r(24330);r(60166);var c=r(6128),d=r(12594),p=r(40618);let l=(e,a)=>{let r=0;return"fixed"===a.discountType?r=a.discountValue:"percentage"===a.discountType&&(r=a.discountValue/100*e),{discountedPrice:Math.max(0,e-r),discountAmount:r}};async function g(e){let a;let{adminDb:r}=(0,c.IW)(),{formData:t,user:i}=await e.json(),n=i?.id||null;if(!n){let a=e.headers.get("Authorization");if(a){let e=a.split("Bearer ")[1];try{n=(await (0,c.y3)(e)).uid}catch(e){}}}let s=r.collection("bookings").doc(),o=await r.doc("settings/charter").get();if(!o.exists)throw Error("Charter settings not found.");let p=(o.data()?.packages).find(e=>e.id===t.charterPackageId);if(!p)throw Error("Selected charter package not found.");let g=(p.basePrice||0)+(p.dailyRate||0)*((t.charterDays||1)-1);if(t.couponCode){let e=await r.collection("promotions").where("code","==",t.couponCode.toUpperCase()).where("status","==","active").limit(1).get();if(e.empty)return new Response(JSON.stringify({message:"The coupon code is invalid or has expired."}),{status:400});{let r=e.docs[0].data();if(!("all"===r.applicableTo||"charter"===r.applicableTo||"specific_package"===r.applicableTo&&r.applicablePackageId===t.charterPackageId))return new Response(JSON.stringify({message:"This coupon code is not valid for this booking type."}),{status:400});{let{discountedPrice:e,discountAmount:t}=l(g,r);g=e,a={code:r.code,amount:t}}}}let u={id:s.id,userId:n,type:"charter",bookingType:"charter",status:"Pending",createdAt:d.FieldValue.serverTimestamp(),passengerName:t.passengerName,passengers:[t.passengerName],passengerPhone:t.passengerPhone,travelDate:t.travelDate,charterPackageId:t.charterPackageId,charterPackageName:t.charterPackageName,charterDays:t.charterDays,pickupAddress:"Charter Service",destinationAddress:"Charter Service",itemDescription:`${t.charterPackageName} for ${t.charterDays} day(s)`,price:g,title:`${t.charterPackageName} Charter`,...a&&{discount:a}};try{return await s.set(u),new Response(JSON.stringify({bookingId:s.id,finalPrice:g}),{status:200})}catch(e){return console.error("Error creating charter booking:",e),new Response(JSON.stringify({message:"Could not create your charter booking at this time."}),{status:500})}}(0,p.h)([g]),(0,o.j)("30c83a6927685a94959b310ea9b180d4183f6ae2",g);let u=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/charter-bookings/route",pathname:"/api/charter-bookings",filename:"route",bundlePath:"app/api/charter-bookings/route"},resolvedPagePath:"/root/app/src/app/api/charter-bookings/route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:v}=u,f="/api/charter-bookings/route";function w(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},49303:(e,a,r)=>{e.exports=r(30517)},6128:(e,a,r)=>{r.d(a,{FH:()=>p,IW:()=>c,y3:()=>d});var t=r(92509),i=r.n(t),n=r(60325),s=r(89155);let o=null;function c(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let a={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,n.getApps)().length?(0,n.getApps)()[0]:i().initializeApp({credential:i().credential.cert(a),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:i().firestore(e),adminAuth:i().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let d=e=>{let{adminAuth:a}=c();return a.verifyIdToken(e)},p=async(e,a)=>{let{adminDb:r}=c(),t=await d(e),i=(await r.doc(`users/${t.uid}`).get()).data();if(!i)throw Error(`Permission Denied: User with UID ${t.uid} not found in Firestore.`);let n=i.role;if(!n||!s._[n])throw Error(`Permission Denied: User role '${n}' is not defined or has no permissions.`);if(!s._[n]?.includes(a))throw Error(`Permission Denied: User with role '${n}' does not have the required '${a}' permission.`);return!0}},89155:(e,a,r)=>{r.d(a,{_:()=>t});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let t={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}}};var a=require("../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[8948,8341],()=>r(55144));module.exports=t})();