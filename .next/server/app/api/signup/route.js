"use strict";(()=>{var e={};e.id=5409,e.ids=[5409],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},98010:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{POST:()=>p});var i=t(49303),s=t(88716),n=t(60670),o=t(87070),u=t(6128),l=t(42e3),d=t(12594),c=t(95323);async function p(e){try{let{adminAuth:r,adminDb:t}=(0,u.IW)(),{email:a,password:i,name:s,phone:n,userType:p,role:m,referralCode:g}=await e.json();if(!a||!i||!s||!p)return o.NextResponse.json({message:"Missing required fields."},{status:400});let f=await (0,l.Hu)(),h={email:a,password:i,displayName:s};n&&n.startsWith("+")&&(h.phoneNumber=n);let v=await r.createUser(h),w=Math.random().toString(36).substring(2,8).toUpperCase(),y={id:v.uid,userId:v.uid,name:s,email:a,phone:n||"",userType:p,status:"Active",dateJoined:new Date().toISOString().split("T")[0],walletBalance:0,walletPin:"",referralCode:w,referralCount:0,referredBy:g||"",fcmToken:"",profilePictureUrl:"",..."admin"===p&&{role:m||"Support"}};return await t.runTransaction(async e=>{let r=t.collection("users").doc(v.uid);if(e.set(r,y),f.referralSystemEnabled&&g){let r=await t.collection("users").where("referralCode","==",g.toUpperCase()).limit(1).get();if(!r.empty){let a=r.docs[0],i=a.ref;e.update(i,{walletBalance:d.FieldValue.increment(f.referralBonus),referralCount:d.FieldValue.increment(1)});let n=t.collection(`users/${a.id}/transactions`).doc();e.set(n,{id:n.id,userId:a.id,type:"credit",amount:f.referralBonus,description:`Referral bonus for signing up ${s}`,date:d.FieldValue.serverTimestamp(),status:"completed"})}}}),await (0,c.x)({title:"New User Joined!",description:`${s} has just signed up as a ${p}.`,type:"user",href:`/admin/dashboard/users/${v.uid}`}),o.NextResponse.json({success:!0,user:y},{status:201})}catch(e){if(console.error("API Error creating user:",e),e.message.includes("Firebase Admin SDK is not initialized"))return o.NextResponse.json({message:"Server Error: Firebase Admin SDK not initialized."},{status:500});if("auth/email-already-exists"===e.code)return o.NextResponse.json({message:"A user with this email already exists."},{status:409});if("auth/phone-number-already-exists"===e.code)return o.NextResponse.json({message:"A user with this phone number already exists."},{status:409});if("auth/invalid-phone-number"===e.code)return o.NextResponse.json({success:!1,message:"The phone number must be a valid E.164 string (e.g., +11234567890)."},{status:400});return o.NextResponse.json({message:`Internal Server Error: ${e.message}`},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/signup/route",pathname:"/api/signup",filename:"route",bundlePath:"app/api/signup/route"},resolvedPagePath:"/root/app/src/app/api/signup/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h}=m,v="/api/signup/route";function w(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},6128:(e,r,t)=>{t.d(r,{FH:()=>d,IW:()=>u,y3:()=>l});var a=t(92509),i=t.n(a),s=t(60325),n=t(89155);let o=null;function u(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let r={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,s.getApps)().length?(0,s.getApps)()[0]:i().initializeApp({credential:i().credential.cert(r),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:i().firestore(e),adminAuth:i().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let l=e=>{let{adminAuth:r}=u();return r.verifyIdToken(e)},d=async(e,r)=>{let{adminDb:t}=u(),a=await l(e),i=(await t.doc(`users/${a.uid}`).get()).data();if(!i)throw Error(`Permission Denied: User with UID ${a.uid} not found in Firestore.`);let s=i.role;if(!s||!n._[s])throw Error(`Permission Denied: User role '${s}' is not defined or has no permissions.`);if(!n._[s]?.includes(r))throw Error(`Permission Denied: User with role '${s}' does not have the required '${r}' permission.`);return!0}},95323:(e,r,t)=>{t.d(r,{i:()=>s,x:()=>i});var a=t(6128);/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 *
 * So, you're looking at my code, huh? That's cool. Just don't copy it without asking.
 * I poured my heart, soul, and a questionable amount of caffeine into this.
 * Find me on socials @mdtbmw if you want to geek out over code.
 */let i=async e=>{let{adminDb:r}=(0,a.IW)(),t=r.collection("users").where("role","==","Manager"),i=await t.get();if(i.empty){console.warn("Trying to notify admins, but I can't find any. Are they all on vacation?");return}let s=r.batch();i.forEach(t=>{let a=t.data(),i=r.collection(`users/${a.id}/notifications`).doc(),n={...e,userId:a.id,read:!1,createdAt:new Date};s.set(i,n)});try{await s.commit()}catch(e){console.error("Failed to send admin notifications. Someone's probably getting a phone call.",e)}},s=async(e,r)=>{let{adminDb:t}=(0,a.IW)();try{let a=t.collection(`users/${e}/notifications`).doc(),i={...r,userId:e,read:!1,createdAt:new Date};await a.set(i)}catch(r){console.error("Failed to send notification to user:",e,r)}}},89155:(e,r,t)=>{t.d(r,{_:()=>a});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let a={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}},42e3:(e,r,t)=>{t.d(r,{Hu:()=>d,Rs:()=>c});var a=t(93820),i=t(29362);let s={apiKey:"AIzaSyB1p5ckuVJpKYR0EUmzweOv42L0GwyhH_M",authDomain:"studio-8506488239-824d2.firebaseapp.com",projectId:"studio-8506488239-824d2",storageBucket:"studio-8506488239-824d2.appspot.com",messagingSenderId:"589723373931",appId:"1:589723373931:web:2e466b46a359c56cc37c2e"};function n(){return(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)(s)}let o={driverRegistrationOpen:!0,driverRegistrationLimit:100,seatHoldDuration:5,requireEmailVerification:!1,requirePhoneVerification:!0,seatBookingEnabled:!0,charterBookingEnabled:!0,referralSystemEnabled:!0,referralBonus:500,authMethods:{email:!0,google:!0}},u={paystackLivePublicKey:"pk_test_a041f0f86a34c38d2a6a5831505c219662d5930e",paystackLiveSecretKey:""},l=null,d=async()=>{let e=n();if(l)return l;let r=(0,a.ad)(e),t=(0,a.JU)(r,"settings","operations");try{let e=await (0,a.QT)(t);if(!e.exists())return o;{let r={...o,...e.data()};return l=r,r}}catch(e){return console.error("Failed to fetch or set operations settings",e),o}};async function c(){let e=n(),r=(0,a.ad)(e),t=(0,a.JU)(r,"settings","payment");try{let e=await (0,a.QT)(t);if(e.exists())return{...u,...e.data()};return u}catch(e){return console.error("Failed to fetch payment settings",e),u}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5059,7999],()=>t(98010));module.exports=a})();