"use strict";(()=>{var e={};e.id=562,e.ids=[562],e.modules={92509:e=>{e.exports=require("firebase-admin")},60325:e=>{e.exports=require("firebase-admin/app")},12594:e=>{e.exports=require("firebase-admin/firestore")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},47799:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{POST:()=>p});var i=t(49303),s=t(88716),n=t(60670),o=t(87070),u=t(6128),c=t(12594),l=t(42e3);async function d(e){let r=await (0,l.Rs)();if(!r?.paystackLiveSecretKey)throw Error("Server configuration error: Paystack secret key is missing.");let t=r.paystackLiveSecretKey;if(!t)throw console.error("PAYSTACK_LIVE_SECRET_KEY is not set in Firestore settings. Cannot verify transaction."),Error("Server configuration error: Paystack live secret key is missing.");try{let r=await fetch(`https://api.paystack.co/transaction/verify/${e}`,{headers:{Authorization:`Bearer ${t}`}});return await r.json()}catch(e){throw console.error("Error verifying Paystack transaction:",e),Error("Could not verify payment with Paystack.")}}async function p(e){try{let{adminDb:r}=(0,u.IW)(),t=e.headers.get("Authorization");if(!t)return o.NextResponse.json({message:"No authorization token provided"},{status:401});let a=t.split("Bearer ")[1],i=(await (0,u.y3)(a)).uid,{amount:s,reference:n}=await e.json();if(!s||!n||s<=0)return o.NextResponse.json({message:"Invalid funding request."},{status:400});let l=await d(n);if(!0!==l.status||"success"!==l.data.status)return o.NextResponse.json({message:"Payment verification failed."},{status:402});let p=r.collection("users").doc(i),m=r.collection(`users/${i}/transactions`).doc(n);if((await m.get()).exists)return o.NextResponse.json({success:!0,message:"Transaction already processed."});let g=r.batch();return g.update(p,{walletBalance:c.FieldValue.increment(s)}),g.set(m,{id:m.id,userId:i,type:"credit",amount:s,description:"Wallet funding via Paystack",date:c.FieldValue.serverTimestamp(),status:"completed",reference:n}),await g.commit(),o.NextResponse.json({success:!0,message:"Wallet funded successfully."})}catch(e){if(console.error("API Error in /api/wallet/fund:",e),e.message.includes("Firebase Admin SDK is not initialized"))return o.NextResponse.json({message:"Server Error: Firebase Admin SDK not initialized."},{status:500});return o.NextResponse.json({message:e.message||"Internal Server Error"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/wallet/fund/route",pathname:"/api/wallet/fund",filename:"route",bundlePath:"app/api/wallet/fund/route"},resolvedPagePath:"/root/app/src/app/api/wallet/fund/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:v}=m,y="/api/wallet/fund/route";function h(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}},6128:(e,r,t)=>{t.d(r,{FH:()=>l,IW:()=>u,y3:()=>c});var a=t(92509),i=t.n(a),s=t(60325),n=t(89155);let o=null;function u(){if(!o)throw Error("Firebase Admin SDK is not initialized. Check server logs and environment variables.");return o}!function(){if(o)return;let e=process.env.FIREBASE_PRIVATE_KEY;if(!e||!process.env.FIREBASE_CLIENT_EMAIL){console.error("CRITICAL ERROR: Firebase Admin credentials are not fully set in environment variables. Admin features will fail.");return}let r={projectId:"studio-8506488239-824d2",clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e.replace(/\\n/g,"\n")};try{let e=(0,s.getApps)().length?(0,s.getApps)()[0]:i().initializeApp({credential:i().credential.cert(r),databaseURL:"https://studio-8506488239-824d2.firebaseio.com"});o={adminApp:e,adminDb:i().firestore(e),adminAuth:i().auth(e)},console.log("Firebase Admin SDK initialized successfully.")}catch(e){console.error("Firebase Admin SDK initialization error:",e.message)}}();let c=e=>{let{adminAuth:r}=u();return r.verifyIdToken(e)},l=async(e,r)=>{let{adminDb:t}=u(),a=await c(e),i=(await t.doc(`users/${a.uid}`).get()).data();if(!i)throw Error(`Permission Denied: User with UID ${a.uid} not found in Firestore.`);let s=i.role;if(!s||!n._[s])throw Error(`Permission Denied: User role '${s}' is not defined or has no permissions.`);if(!n._[s]?.includes(r))throw Error(`Permission Denied: User with role '${s}' does not have the required '${r}' permission.`);return!0}},89155:(e,r,t)=>{t.d(r,{_:()=>a});/**
 * @project Engraced Smiles
 * @author Daniel Innocent <@mdtbmw>
 * @copyright Copyright (c) 2024. All rights reserved.
 * This software is the exclusive property of Daniel Innocent.
 * A license has been granted to Mr. Ismail Muhammed for resale to Engraced Smiles.
 */let a={Manager:["viewDashboard","viewOperations","viewFinancials","viewAnalytics","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageTeam","managePayouts","managePayments","sendNotifications","viewReports","manageTemplates","managePrograms","managePromotions","manageSupport","manageEmergencies","manageSettings","manageFrontend","manageSystem","viewMarketing","manageInventory"],Support:["viewDashboard","viewOperations","manageShipments","manageUsers","manageDrivers","viewMore","manageAccount","manageSupport","manageEmergencies"],Finance:["viewDashboard","viewFinancials","viewAnalytics","viewMore","manageAccount","managePayouts","managePayments","viewReports","manageSettings"],Marketing:["viewDashboard","viewMarketing","viewAnalytics","viewMore","manageAccount","sendNotifications","manageTemplates","managePrograms","managePromotions","manageFrontend"]}},42e3:(e,r,t)=>{t.d(r,{Hu:()=>l,Rs:()=>d});var a=t(93820),i=t(29362);let s={apiKey:"AIzaSyB1p5ckuVJpKYR0EUmzweOv42L0GwyhH_M",authDomain:"studio-8506488239-824d2.firebaseapp.com",projectId:"studio-8506488239-824d2",storageBucket:"studio-8506488239-824d2.appspot.com",messagingSenderId:"589723373931",appId:"1:589723373931:web:2e466b46a359c56cc37c2e"};function n(){return(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)(s)}let o={driverRegistrationOpen:!0,driverRegistrationLimit:100,seatHoldDuration:5,requireEmailVerification:!1,requirePhoneVerification:!0,seatBookingEnabled:!0,charterBookingEnabled:!0,referralSystemEnabled:!0,referralBonus:500,authMethods:{email:!0,google:!0}},u={paystackLivePublicKey:"pk_test_a041f0f86a34c38d2a6a5831505c219662d5930e",paystackLiveSecretKey:""},c=null,l=async()=>{let e=n();if(c)return c;let r=(0,a.ad)(e),t=(0,a.JU)(r,"settings","operations");try{let e=await (0,a.QT)(t);if(!e.exists())return o;{let r={...o,...e.data()};return c=r,r}}catch(e){return console.error("Failed to fetch or set operations settings",e),o}};async function d(){let e=n(),r=(0,a.ad)(e),t=(0,a.JU)(r,"settings","payment");try{let e=await (0,a.QT)(t);if(e.exists())return{...u,...e.data()};return u}catch(e){return console.error("Failed to fetch payment settings",e),u}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5059,7999],()=>t(47799));module.exports=a})();